<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Alternative clojure.test Integration With test.check</title>
  <meta name="description" content="I’ve enjoyed using test.check lately, but its integration with clojure.test doesn’t fit with how I want to use it very well. In this post we’re going to expl...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="http://blog.colinwilliams.name/clojure/testing/2015/01/26/alternative-clojure-dot-test-integration-with-test-dot-check.html">
  <link rel="alternate" type="application/rss+xml" title="Public Notes" href="/feed.xml">
  
  
</head>


  <body>

    <header class="site-header" role="banner">

  <div class="wrapper">
    
    
    <a class="site-title" href="/">Public Notes</a>
  
    
      <nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
              <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
              <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger">
          
            
            
            <a class="page-link" href="/about/">About</a>
            
          
            
            
          
            
            
          
            
            
          
        </div>
      </nav>
    
  </div>
</header>


    <main class="page-content" aria-label="Content">
      <div class="wrapper">
        <h1>Alternative clojure.test Integration With test.check</h1>

<p>I’ve enjoyed using <a href="https://github.com/clojure/test.check">test.check</a> lately, but its integration with <a href="https://clojure.github.io/clojure/clojure.test-api.html">clojure.test</a> doesn’t fit with how I want to use it very well.  In this post we’re going to explore a different approach, which I’m going to try to get into <a href="https://github.com/gfredericks/test.chuck">test.chuck</a>.</p>

<h2 id="the-problem">The Problem</h2>
<p>To demonstrate my difficulty, consider these basic tests in <code class="highlighter-rouge">clojure.test</code>:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">integer-facts</span><span class="w">
  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">"positive"</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w">
  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">"negative"</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">-1</span><span class="w"> </span><span class="mi">0</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">-24</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span><span class="w">
</span></code></pre>
</div>

<p>Instead of checking hard-coded integers, I would prefer <code class="highlighter-rouge">test.check</code> to do its magic.  To do this using <code class="highlighter-rouge">defspec</code> (the existing integration option), I would have to do something like this:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">defspec</span><span class="w"> </span><span class="n">positive-integer-facts</span><span class="w"> </span><span class="mi">100</span><span class="w">
  </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/s-pos-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="nf">defspec</span><span class="w"> </span><span class="n">negative-integer-facts</span><span class="w"> </span><span class="mi">100</span><span class="w">
  </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/s-neg-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w">
</span></code></pre>
</div>

<p>There’s a lot of boilerplate here, and it’s not communicating that these two properties are related.  Alternatively, I could join everything into one big condition:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">defspec</span><span class="w"> </span><span class="n">integer-facts</span><span class="w"> </span><span class="mi">100</span><span class="w">
  </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="p">[</span><span class="n">p</span><span class="w"> </span><span class="n">gen/s-pos-int</span><span class="w">
                 </span><span class="n">n</span><span class="w"> </span><span class="n">gen/s-neg-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w">
         </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span><span class="w">
</span></code></pre>
</div>

<p>This is also unsatisfying, as I wouldn’t be able to tell easily what failed.</p>

<p>Setting aside that issue for now, let’s look at the output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lein test checking.core-test
{:test-var "positive-integer-facts", :result true, :num-tests 100, :seed 1422280152456}
{:test-var "negative-integer-facts", :result true, :num-tests 100, :seed 1422280152465}

Ran 2 tests containing 2 assertions.
0 failures, 0 errors.
</code></pre>
</div>

<p>Unlike <code class="highlighter-rouge">deftest</code>, <code class="highlighter-rouge">defspec</code> prints a report even when it passes.  If I start using properties liberally my test output will quickly get too noisy.</p>

<p>The transition path is also difficult.  Look at the original <code class="highlighter-rouge">deftest</code> code and notice that moving to <code class="highlighter-rouge">defspec</code> feels like a complete rewrite, as opposed to an upgrade from hard-coded to generated values.</p>

<p>Also, consider the case where we’re performing multiple assertions stepping through a stateful piece of code.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">counter</span><span class="w">
  </span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="s">"increasing"</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="err">@</span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w">
      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">c</span><span class="w"> </span><span class="mi">0</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>

<p>Moving this to <code class="highlighter-rouge">defspec</code> can be tricky:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">defspec</span><span class="w"> </span><span class="n">increasing-counter</span><span class="w"> </span><span class="mi">100</span><span class="w">
  </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/s-pos-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">i</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">single-inc</span><span class="w"> </span><span class="err">@</span><span class="n">c</span><span class="p">]</span><span class="w">
        </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
        </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">single-inc</span><span class="w"> </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">i</span><span class="p">))</span><span class="w">
             </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">c</span><span class="w"> </span><span class="mi">0</span><span class="p">))))))</span><span class="w">
</span></code></pre>
</div>

<h2 id="the-alternative">The Alternative</h2>
<p>What I’d really like to say is exactly the same thing as the original <code class="highlighter-rouge">deftest</code> code, with just a little bit of variation for the generated values:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">integer-facts</span><span class="w">
  </span><span class="p">(</span><span class="nf">checking</span><span class="w"> </span><span class="s">"positive"</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/s-pos-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w">
  </span><span class="p">(</span><span class="nf">checking</span><span class="w"> </span><span class="s">"negative"</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/s-neg-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">0</span><span class="p">))))</span><span class="w">

</span><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">counter</span><span class="w">
  </span><span class="p">(</span><span class="nf">checking</span><span class="w"> </span><span class="s">"increasing"</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/s-pos-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">i</span><span class="p">)]</span><span class="w">
      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="err">@</span><span class="n">c</span><span class="w"> </span><span class="p">(</span><span class="nb">inc</span><span class="w"> </span><span class="n">i</span><span class="p">)))</span><span class="w">
      </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="nb">inc</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&gt;</span><span class="w"> </span><span class="err">@</span><span class="n">c</span><span class="w"> </span><span class="mi">0</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>

<p>Notice how simple it is to move from <code class="highlighter-rouge">testing</code> to <code class="highlighter-rouge">checking</code>.  With <code class="highlighter-rouge">defspec</code> the code screams generative testing and mentions the assertions as an aside.  With <code class="highlighter-rouge">checking</code> generative testing becomes the aside and the assertions becomes the focus.</p>

<h2 id="naive-implementation">Naive Implementation</h2>
<p>A first pass on <code class="highlighter-rouge">checking</code> looks something like this:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="mi">100</span><span class="w">
       </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w"> </span><span class="o">~@</span><span class="n">body</span><span class="p">))))</span><span class="w">
</span></code></pre>
</div>

<p>This works because the <code class="highlighter-rouge">is</code> macro completely bypasses the <code class="highlighter-rouge">tc/quick-check</code> construct.  While this gets us limping along, there are a couple problems.</p>

<p>First, let’s force a failure:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">failure</span><span class="w">
  </span><span class="p">(</span><span class="nf">checking</span><span class="w"> </span><span class="s">"incorrect"</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/pos-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">))))</span><span class="w">
</span></code></pre>
</div>

<p>Now look at the output for this failure:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="n">FAIL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">failure</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">core_test.clj</span><span class="no">:64</span><span class="p">)</span><span class="w">
</span><span class="n">incorrect</span><span class="w">
</span><span class="n">expected</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w">
  </span><span class="n">actual</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">55</span><span class="w"> </span><span class="mi">50</span><span class="p">))</span><span class="w">

</span><span class="n">lein</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="n">checking.core-test/failure</span><span class="w">

</span><span class="n">FAIL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">failure</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">core_test.clj</span><span class="no">:64</span><span class="p">)</span><span class="w">
</span><span class="n">incorrect</span><span class="w">
</span><span class="n">expected</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w">
  </span><span class="n">actual</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">52</span><span class="w"> </span><span class="mi">50</span><span class="p">))</span><span class="w">

</span><span class="n">lein</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="n">checking.core-test/failure</span><span class="w">

</span><span class="n">...</span><span class="w">
</span></code></pre>
</div>

<p>We’re seeing a failure for every attempt when <code class="highlighter-rouge">tc/quick-check</code> tries to narrow down to the smallest failure.  All we really want to know about is the result of this search.</p>

<p>The other problem is that <code class="highlighter-rouge">tc/quick-check</code> only traces when the final sexp is false:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="nf">deftest</span><span class="w"> </span><span class="n">unsearched-failure</span><span class="w">
  </span><span class="p">(</span><span class="nf">checking</span><span class="w"> </span><span class="s">"incorrect"</span><span class="w"> </span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="n">gen/pos-int</span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">))</span><span class="w">
    </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="n">i</span><span class="p">))))</span><span class="w">
</span></code></pre>
</div>

<p>Which becomes obvious in the test output:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="n">FAIL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">unsearched-failure</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">core_test.clj</span><span class="no">:68</span><span class="p">)</span><span class="w">
</span><span class="n">incorrect</span><span class="w">
</span><span class="n">expected</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w">
  </span><span class="n">actual</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">57</span><span class="w"> </span><span class="mi">50</span><span class="p">))</span><span class="w">

</span><span class="n">lein</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="n">checking.core-test/unsearched-failure</span><span class="w">

</span><span class="n">FAIL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">unsearched-failure</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">core_test.clj</span><span class="no">:68</span><span class="p">)</span><span class="w">
</span><span class="n">incorrect</span><span class="w">
</span><span class="n">expected</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w">
  </span><span class="n">actual</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">61</span><span class="w"> </span><span class="mi">50</span><span class="p">))</span><span class="w">

</span><span class="n">...</span><span class="w">

</span><span class="n">lein</span><span class="w"> </span><span class="nb">test</span><span class="w"> </span><span class="no">:only</span><span class="w"> </span><span class="n">checking.core-test/unsearched-failure</span><span class="w">

</span><span class="n">FAIL</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="p">(</span><span class="nf">unsearched-failure</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">core_test.clj</span><span class="no">:68</span><span class="p">)</span><span class="w">
</span><span class="n">incorrect</span><span class="w">
</span><span class="n">expected</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="mi">50</span><span class="p">)</span><span class="w">
  </span><span class="n">actual</span><span class="err">:</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">&lt;</span><span class="w"> </span><span class="mi">90</span><span class="w"> </span><span class="mi">50</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<h2 id="intercepting-reporting">Intercepting Reporting</h2>
<p>We’re seeing the failure, but getting a lot of noise as well.  What we really need here is an alternative test-reporting framework that can be nested within the checking macro.  Fortunately, <code class="highlighter-rouge">clojure.test</code> is designed to replace that framework by overriding the report multimethod.  Let’s look at what one of these reports looks like:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="n">user&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">nil</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.test/report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)))</span><span class="w"> </span><span class="err">@</span><span class="n">result</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="no">:message</span><span class="w"> </span><span class="n">nil,</span><span class="w"> </span><span class="no">:actual</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">))</span><span class="n">,</span><span class="w"> </span><span class="no">:expected</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="n">,</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:fail,</span><span class="w">
 </span><span class="no">:file</span><span class="w"> </span><span class="s">"form-init7960148245055492106.clj"</span><span class="n">,</span><span class="w"> </span><span class="no">:line</span><span class="w"> </span><span class="mi">1</span><span class="p">}</span><span class="w">

</span><span class="n">user&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">nil</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.test/report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)))</span><span class="w"> </span><span class="err">@</span><span class="n">result</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="no">:type</span><span class="w"> </span><span class="no">:pass,</span><span class="w"> </span><span class="no">:expected</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="n">,</span><span class="w"> </span><span class="no">:actual</span><span class="w"> </span><span class="p">(</span><span class="o">#</span><span class="n">&lt;core$_EQ_</span><span class="w"> </span><span class="n">clojure.core$_EQ_</span><span class="err">@</span><span class="mi">39877</span><span class="n">a52&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="n">,</span><span class="w">
 </span><span class="no">:message</span><span class="w"> </span><span class="n">nil</span><span class="p">}</span><span class="w">

</span><span class="n">user&gt;</span><span class="w"> </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">nil</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">clojure.test/report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
        </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="err">@</span><span class="n">result</span><span class="p">)</span><span class="w">
</span><span class="p">{</span><span class="no">:message</span><span class="w"> </span><span class="n">nil,</span><span class="w"> </span><span class="no">:actual</span><span class="w"> </span><span class="o">#</span><span class="n">&lt;ArithmeticException</span><span class="w"> </span><span class="n">java.lang.ArithmeticException</span><span class="err">:</span><span class="w"> </span><span class="n">Divide</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">zero&gt;,</span><span class="w">
 </span><span class="no">:expected</span><span class="w"> </span><span class="p">(</span><span class="nb">/</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="n">,</span><span class="w"> </span><span class="no">:type</span><span class="w"> </span><span class="no">:error,</span><span class="w"> </span><span class="no">:file</span><span class="w"> </span><span class="s">"Numbers.java"</span><span class="n">,</span><span class="w"> </span><span class="no">:line</span><span class="w"> </span><span class="mi">156</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<p>So the condition <code class="highlighter-rouge">quick-check</code> is looking for is actually if :type is not :pass.  If we could catch that investigations would work correctly:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="no">:result</span><span class="w"> </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="mi">100</span><span class="w">
                    </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w">
                      </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">pass</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="n">true</span><span class="p">)]</span><span class="w">
                        </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">pass</span><span class="o">#</span><span class="w">
                                                     </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="o">#</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nb">and</span><span class="w"> </span><span class="n">r</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:pass</span><span class="p">))))]</span><span class="w">
                          </span><span class="o">~@</span><span class="n">body</span><span class="p">)</span><span class="w">
                        </span><span class="err">@</span><span class="n">pass</span><span class="o">#</span><span class="p">)))))))</span><span class="w">
</span></code></pre>
</div>

<p>Output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>FAIL in (searched-failure) (core_test.clj:63)
incorrect
expected: (:result (clojure.test.check/quick-check 100 (clojure.test.check.properties/for-all [i gen/pos-int] (clojure.core/let [pass__616__auto__ (clojure.core/atom true)] (clojure.core/with-redefs [clojure.test/report (fn* [p1__615__617__auto__] (clojure.core/swap! pass__616__auto__ (clojure.core/fn [r__618__auto__] (clojure.core/and r__618__auto__ (clojure.core/= (:type p1__615__617__auto__) :pass)))))] (is (&lt; i 50))) (clojure.core/deref pass__616__auto__)))))
  actual: false
</code></pre>
</div>

<h2 id="tracking-reports">Tracking Reports</h2>
<p>This guarantees that the investigation happens, but we’ve lost the individual assertions in the process.  What we need is a way to get at only those reports which were generated in the final failing execution.  There’s not a mechanism for passing information out of a failure, so we’ll have to use a closure with some state to simulate the effect:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
       </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="mi">100</span><span class="w">
        </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w">
          </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
            </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
              </span><span class="o">~@</span><span class="n">body</span><span class="p">)</span><span class="w">
            </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">pass</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nb">every?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:pass</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">)]</span><span class="w">
              </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">pass</span><span class="o">#</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">))</span><span class="w">
                </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">))</span><span class="w">
              </span><span class="n">pass</span><span class="o">#</span><span class="p">))))</span><span class="w">
       </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">report</span><span class="w"> </span><span class="n">r</span><span class="o">#</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>

<p>And the output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lein test :only checking.core-test/unsearched-failure

FAIL in (unsearched-failure) (core_test.clj:68)
incorrect
expected: (&lt; i 50)
  actual: (not (&lt; 50 50))
</code></pre>
</div>

<h2 id="including-results">Including Results</h2>
<p>So things are functioning correctly, and the failures are easy to read.  In more complex scenarios the value may have been transformed heavily before the assertion is made, in which case we want to present the <code class="highlighter-rouge">tc/quick-check</code> return value.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
       </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="mi">100</span><span class="w">
                       </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w">
                         </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
                           </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
                             </span><span class="o">~@</span><span class="n">body</span><span class="p">)</span><span class="w">
                           </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">pass</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nb">every?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:pass</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">)]</span><span class="w">
                             </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="n">pass</span><span class="o">#</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">))</span><span class="w">
                               </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">))</span><span class="w">
                             </span><span class="n">pass</span><span class="o">#</span><span class="p">))))]</span><span class="w">
         </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="no">:result</span><span class="w"> </span><span class="n">result</span><span class="o">#</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="o">#</span><span class="p">))</span><span class="w">
       </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">report</span><span class="w"> </span><span class="n">r</span><span class="o">#</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>

<p>Output:</p>

<div class="highlighter-rouge"><pre class="highlight"><code>lein test :only checking.core-test/unsearched-failure

FAIL in (unsearched-failure) (core_test.clj:67)
incorrect
{:result false, :seed 1422311111994, :failing-size 58, :num-tests 59, :fail [55],
 :shrunk {:total-nodes-visited 23, :depth 3, :result false, :smallest [50]}}
expected: (:result result__618__auto__)
  actual: false

lein test :only checking.core-test/unsearched-failure

FAIL in (unsearched-failure) (core_test.clj:68)
incorrect
expected: (&lt; i 50)
  actual: (not (&lt; 50 50))
</code></pre>
</div>

<h2 id="cleaning-up">Cleaning Up</h2>
<p>I’m happy with how things are reported now, but the code is a pretty big mess.  Decomposing the logic should help with that:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">report-when-failing</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="no">:result</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">capture-reports</span><span class="w"> </span><span class="p">[</span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
     </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
       </span><span class="o">~@</span><span class="n">body</span><span class="p">)</span><span class="w">
     </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">pass?</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">every?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:pass</span><span class="p">)</span><span class="w"> </span><span class="n">reports</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">report-needed?</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="w"> </span><span class="n">final-reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nf">pass?</span><span class="w"> </span><span class="n">reports</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="n">final-reports</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">save-to-final-reports</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="w"> </span><span class="n">final-reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">report-needed?</span><span class="w"> </span><span class="n">reports</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">final-reports</span><span class="w"> </span><span class="n">reports</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
       </span><span class="p">(</span><span class="nf">report-when-failing</span><span class="w"> </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="mi">100</span><span class="w">
                              </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w">
                                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">capture-reports</span><span class="w"> </span><span class="o">~</span><span class="n">body</span><span class="p">)]</span><span class="w">
                                  </span><span class="p">(</span><span class="nf">save-to-final-reports</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="n">final-reports</span><span class="o">#</span><span class="p">)</span><span class="w">
                                  </span><span class="p">(</span><span class="nf">pass?</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="p">)))))</span><span class="w">
       </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">report</span><span class="w"> </span><span class="n">r</span><span class="o">#</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>

<h2 id="number-of-tests">Number of Tests</h2>
<p>One final touch is that the number of tests really shouldn’t be hard-coded.  This adds to the <code class="highlighter-rouge">checking</code> footprint slightly, but that seems worth it to simplify our ability to control the number of tests being run.</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">report-when-failing</span><span class="w"> </span><span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nf">is</span><span class="w"> </span><span class="p">(</span><span class="no">:result</span><span class="w"> </span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">capture-reports</span><span class="w"> </span><span class="p">[</span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
     </span><span class="p">(</span><span class="nf">with-redefs</span><span class="w"> </span><span class="p">[</span><span class="n">report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
       </span><span class="o">~@</span><span class="n">body</span><span class="p">)</span><span class="w">
     </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">pass?</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">every?</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nb">=</span><span class="w"> </span><span class="p">(</span><span class="no">:type</span><span class="w"> </span><span class="n">%</span><span class="p">)</span><span class="w"> </span><span class="no">:pass</span><span class="p">)</span><span class="w"> </span><span class="n">reports</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">report-needed?</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="w"> </span><span class="n">final-reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">or</span><span class="w"> </span><span class="p">(</span><span class="nb">not</span><span class="w"> </span><span class="p">(</span><span class="nf">pass?</span><span class="w"> </span><span class="n">reports</span><span class="p">))</span><span class="w"> </span><span class="p">(</span><span class="nf">empty?</span><span class="w"> </span><span class="n">final-reports</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">save-to-final-reports</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="w"> </span><span class="n">final-reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="nb">when</span><span class="w"> </span><span class="p">(</span><span class="nf">report-needed?</span><span class="w"> </span><span class="n">reports</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">final-reports</span><span class="w"> </span><span class="n">reports</span><span class="p">)))</span><span class="w">

</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
       </span><span class="p">(</span><span class="nf">report-when-failing</span><span class="w"> </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="o">~</span><span class="n">tests</span><span class="w">
                              </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w">
                                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">capture-reports</span><span class="w"> </span><span class="o">~</span><span class="n">body</span><span class="p">)]</span><span class="w">
                                  </span><span class="p">(</span><span class="nf">save-to-final-reports</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="n">final-reports</span><span class="o">#</span><span class="p">)</span><span class="w">
                                  </span><span class="p">(</span><span class="nf">pass?</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="p">)))))</span><span class="w">
       </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">report</span><span class="w"> </span><span class="n">r</span><span class="o">#</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>

<h1 id="update">Update</h1>
<p>The macro has been accepted to <a href="https://github.com/gfredericks/test.chuck">test.chuck</a> in release 0.1.12.  <a href="https://github.com/gfredericks">Gary Fredericks</a> helped me work out some concurrency problems with the above implementation.</p>

<p>First, <code class="highlighter-rouge">with-redefs</code> rebinds things globally, which means that we can end up saving to the wrong atom.  It’s much better to use <code class="highlighter-rouge">binding</code>:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">capture-reports</span><span class="w"> </span><span class="p">[</span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
     </span><span class="p">(</span><span class="nb">binding</span><span class="w"> </span><span class="p">[</span><span class="n">report</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="nb">conj</span><span class="w"> </span><span class="n">%</span><span class="p">)]</span><span class="w">
       </span><span class="o">~@</span><span class="n">body</span><span class="p">)</span><span class="w">
     </span><span class="err">@</span><span class="n">reports</span><span class="o">#</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<p>Second, using <code class="highlighter-rouge">reset!</code> in <code class="highlighter-rouge">save-to-final-reports</code> causes a race condition between checking the condition and assigning to the atom.  To get around this we can rearrange the arguments of <code class="highlighter-rouge">save-to-final-reports</code> and call <code class="highlighter-rouge">swap!</code> instead:</p>

<div class="language-clojure highlighter-rouge"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">save-to-final-reports</span><span class="w"> </span><span class="p">[</span><span class="n">final-reports</span><span class="w"> </span><span class="n">reports</span><span class="p">]</span><span class="w">
  </span><span class="p">(</span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nf">report-needed?</span><span class="w"> </span><span class="n">reports</span><span class="w"> </span><span class="n">final-reports</span><span class="p">)</span><span class="w">
    </span><span class="n">reports</span><span class="w">
    </span><span class="n">final-reports</span><span class="p">))</span><span class="w">

</span><span class="p">(</span><span class="k">defmacro</span><span class="w"> </span><span class="n">checking</span><span class="w">
  </span><span class="p">[</span><span class="nb">name</span><span class="w"> </span><span class="n">tests</span><span class="w"> </span><span class="n">bindings</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">body</span><span class="p">]</span><span class="w">
  </span><span class="o">`</span><span class="p">(</span><span class="nf">testing</span><span class="w"> </span><span class="o">~</span><span class="nb">name</span><span class="w">
     </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">atom</span><span class="w"> </span><span class="p">[])]</span><span class="w">
       </span><span class="p">(</span><span class="nf">report-when-failing</span><span class="w"> </span><span class="p">(</span><span class="nf">tc/quick-check</span><span class="w"> </span><span class="o">~</span><span class="n">tests</span><span class="w">
                              </span><span class="p">(</span><span class="nf">prop/for-all</span><span class="w"> </span><span class="o">~</span><span class="n">bindings</span><span class="w">
                                </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">reports</span><span class="o">#</span><span class="w"> </span><span class="p">(</span><span class="nf">capture-reports</span><span class="w"> </span><span class="o">~</span><span class="n">body</span><span class="p">)]</span><span class="w">
                                  </span><span class="p">(</span><span class="nf">swap!</span><span class="w"> </span><span class="n">final-reports</span><span class="o">#</span><span class="w"> </span><span class="n">save-to-final-reports</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="p">)</span><span class="w">
                                  </span><span class="p">(</span><span class="nf">pass?</span><span class="w"> </span><span class="n">reports</span><span class="o">#</span><span class="p">)))))</span><span class="w">
       </span><span class="p">(</span><span class="nb">doseq</span><span class="w"> </span><span class="p">[</span><span class="n">r</span><span class="o">#</span><span class="w"> </span><span class="err">@</span><span class="n">final-reports</span><span class="o">#</span><span class="p">]</span><span class="w">
         </span><span class="p">(</span><span class="nf">report</span><span class="w"> </span><span class="n">r</span><span class="o">#</span><span class="p">)))))</span><span class="w">
</span></code></pre>
</div>


<div id="disqus_thread"></div>
<script>
	/**
	*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
	*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
	*/
	var disqus_config = function () {
	this.page.url = "http://blog.colinwilliams.name/clojure/testing/2015/01/26/alternative-clojure-dot-test-integration-with-test-dot-check.html";  // Replace PAGE_URL with your page's canonical URL variable
	this.page.identifier = "/clojure/testing/2015/01/26/alternative-clojure-dot-test-integration-with-test-dot-check"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
	};
	(function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
	var d = document, s = d.createElement('script');

	s.src = 'https://lackita.disqus.com/embed.js';  // IMPORTANT: Replace EXAMPLE with your forum shortname!

	s.setAttribute('data-timestamp', +new Date());
	(d.head || d.body).appendChild(s);
	})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
	}


      </div>
    </main>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Public Notes</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>
            
              Public Notes
            
            </li>
            
            <li><a href="mailto:colin@colinwilliams.name">colin@colinwilliams.name</a></li>
            
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/jekyll"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">jekyll</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/jekyllrb"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">jekyllrb</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>Rather than trying to generate content I think people will find generally interesting, I have decided to switch to publishing my notes on whatever I happen to be working on.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
